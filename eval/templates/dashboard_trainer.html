{% extends "base.html" %}
{% load url_filters %}

{% block title %}Trainer Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Welcome Section -->
    <div class="mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Trainer Dashboard</h1>
        <p class="text-lg text-gray-500">Track your assigned tasks, progress, and references in a beautiful, modern dashboard.</p>
    </div>

    <!-- Project Dropdown -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center md:gap-6">
        <form method="get" class="flex items-center gap-4">
            <label for="project" class="font-semibold text-gray-700">Project:</label>
            <select name="project" id="project" class="border rounded p-2 min-w-[200px]" onchange="this.form.submit()">
                <option value="">-- Choose Project --</option>
                {% for project in projects %}
                    <option value="{{ project.id }}" {% if project.id|stringformat:"s" == selected_project %}selected{% endif %}>{{ project.code }} - {{ project.name }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Table Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Assigned Tasks</h2>
        </div>
        <div class="overflow-x-auto rounded-2xl shadow-lg">
            <table class="min-w-full border-separate border-spacing-0 bg-white rounded-2xl overflow-hidden">
                <thead class="sticky top-0 z-10 bg-gradient-to-r from-blue-100 to-blue-50 shadow">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-800 uppercase tracking-wider rounded-tl-2xl">Edit</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Question Id</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Problem Link</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Reference Links</th>
                        {% for header in headers %}
                            {% if header != "question_id" and header != "Problem Link" and header != "response_links" and header != "raw_prompt" %}
                                <th class="px-6 py-4 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">{{ header }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% if tasks and selected_project %}
                        {% for task in tasks %}
                            <tr class="even:bg-blue-50 odd:bg-white hover:bg-blue-100 transition-all duration-150">
                                <td class="px-6 py-4">
                                    <a href="{% url 'edit_trainer_task' task.id %}" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-sm font-semibold shadow">
                                        Edit
                                    </a>
                                </td>
                                <!-- Question Id as link -->
                                <td class="px-6 py-4">
                                    {% if task.question_id %}
<a href="{% url 'trainer_question_analysis' selected_project task.question_id %}" class="text-blue-700 font-semibold hover:underline">
    {{ task.question_id }}
</a>
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <!-- Problem Link as link -->
                                <td class="px-6 py-4">
                                    {% if task.problem_link %}
                                        <a href="{{ task.problem_link }}" target="_blank" class="text-blue-600 hover:underline font-medium">
                                            View Problem
                                        </a>
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <!-- Reference Links as link(s) -->
                                <td class="px-6 py-4">
                                    {% if task.response_links %}
                                        <div class="flex flex-wrap gap-2">
                                            {% for link in task.response_links|split:"," %}
                                                <a href="{{ link|trim }}" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap font-medium">
                                                    Reference {{ forloop.counter }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <!-- Other columns except raw_prompt, question_id, Problem Link, response_links -->
                                {% for header in headers %}
                                    {% if header != "question_id" and header != "problem_link" and header != "response_links" and header != "raw_prompt" %}
                                        <td class="px-6 py-4">
                                            {% if header == "completed" %}
                                                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                                                    {% if task.completed == "Completed" %}
                                                        bg-green-100 text-green-800
                                                    {% elif task.completed == "In Progress" %}
                                                        bg-yellow-100 text-yellow-800
                                                    {% elif task.completed == "Review Required" %}
                                                        bg-orange-100 text-orange-800
                                                    {% else %}
                                                        bg-gray-100 text-gray-700
                                                    {% endif %}
                                                ">
                                                    {{ task.completed|default:"-" }}
                                                </span>
                                            {% else %}
                                                {{ task|attr:header|default:"-" }}
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{{ headers|length }}" class="text-center text-gray-400 py-8">
                                Choose the project to see your assigned tasks
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls -->
        <div class="flex justify-center items-center mt-8 overflow-x-auto space-x-2">
            {% if pagination.has_previous %}
                <a href="?page={{ pagination.previous_page }}{% if selected_project %}&project={{ selected_project }}{% endif %}" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 transition">&laquo; Prev</a>
            {% endif %}
            {% for p in visible_page_numbers %}
                {% if p == "..." %}
                    <span class="px-2">...</span>
                {% elif p == pagination.current_page %}
                    <span class="px-3 py-1 rounded-lg bg-blue-600 text-white font-bold shadow">{{ p }}</span>
                {% else %}
                    <a href="?page={{ p }}{% if selected_project %}&project={{ selected_project }}{% endif %}" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 transition">{{ p }}</a>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
                <a href="?page={{ pagination.next_page }}{% if selected_project %}&project={{ selected_project }}{% endif %}" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 transition">Next &raquo;</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
